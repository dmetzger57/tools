#!/bin/bash

>/tmp/changed_files.txt
>/tmp/unchanged_files.txt

# --- SQLite escaping helper ---
sqlite3_escape() {
  echo "$1" | sed "s/'/''/g"
}

# --- Parse CLI options ---
while getopts "d:" opt; do
  case $opt in
    d) db_name="$OPTARG" ;;
    *) echo "Usage: $0 [-d database_name]" ; exit 1 ;;
  esac
done

# --- Prompt if missing ---
if [ -z "$db_name" ]; then
  read -rp "Enter the database name (without extension): " db_name
fi

# --- Setup paths ---
db_dir="$HOME/db"
db_file="$db_dir/$db_name.db"

if [ ! -f "$db_file" ]; then
  echo "❌ Database not found: $db_file"
  exit 1
fi

# --- Initialize counters ---
unchanged_count=0
changed_count=0
changed_files=()

echo "🔍 Verifying files from database: $db_file"

# --- Query all file paths and checksums from the DB ---
sqlite3 -separator '|' "$db_file" "SELECT full_path, checksum FROM files;" | while IFS='|' read -r full_path stored_checksum; do

  if [ ! -f "$full_path" ]; then
    echo "⚠️ Skipping missing file: $full_path"
    continue
  fi

  current_checksum=$(shasum -a 256 "$full_path" | awk '{print $1}')

  if [ "$current_checksum" == "$stored_checksum" ]; then
    echo "$full_path" >>/tmp/unchanged_files.txt
  else
    modified_date=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" "$full_path")
    echo "$full_path,$modified_date" >>/tmp/changed_files.txt
  fi
done

changed_count=`cat /tmp/changed_files.txt | wc -l`
unchanged_count=`cat /tmp/unchanged_files.txt | wc -l`

# --- Report Summary ---
echo -e "\n📄 Verification Report:"
echo "Unchanged files: $unchanged_count"
echo "Changed files:   $changed_count"

if [ $changed_count -gt 0 ]; then
  echo -e "\n📝 List of Changed Files:"
  cat /tmp/changed_files.txt
fi

rm -f /tmp/changed_files.txt
rm -f /tmp/unchanged_files.txt
